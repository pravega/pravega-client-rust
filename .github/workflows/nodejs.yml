name: packaging and publish to nodejs

on:
  workflow_dispatch:
  pull_request:
    branches:
      - master

jobs:
  nodejs-github:
    name: nodejs${{ matrix.node_version }}-${{ matrix.system.target }} ${{ matrix.system.os }}
    runs-on: ${{ matrix.system.os }}
    strategy:
      fail-fast: false
      matrix:
        node_version:
#           - 12
#           - 14
          - 16
        system:
#           - os: macos-10.15
#             target: x86_64-apple-darwin
          - os: ubuntu-20.04
            target: x86_64-unknown-linux-gnu
#           - os: windows-2019
#             target: x86_64-pc-windows-msvc
#         include:
#           # only node 15+ supports arm64 natively, so we only need to build 16 for now
#           - system:
#               os: [self-hosted, macOS, ARM64]
#               target: aarch64-apple-darwin
#             node_version: 16
    steps:
      - uses: actions/checkout@v2
        # with:
        #   ref: ${{ github.event.release.tag_name }}
      - uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node_version }}
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          target: ${{ matrix.system.target }}
          override: true
      - name: Install modules
        run: cd nodejs && npm i
      - name: Build
        id: build
        # Use bash, even on Windows.
        shell: bash
        env:
          PRE_GYP_PLATFORM: ${{ matrix.system.pre_gyp_platform }}
          PRE_GYP_ARCH: ${{ matrix.system.pre_gyp_arch }}
          CARGO_BUILD_TARGET: ${{ matrix.system.target }}
        run: npm run release
      - name: Upload release asset
        run: gh release upload ${{ github.event.release.tag_name }} bin-package/${{ steps.build.outputs.asset }} --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
